<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <script src="https://gw.alipayobjects.com/os/lib/react/16.10.2/umd/react.development.js"
        crossorigin="anonymous"></script>
    <script src="https://gw.alipayobjects.com/os/lib/react-dom/16.10.2/umd/react-dom.development.js"
        crossorigin="anonymous"></script>
    <script src="https://gw.alipayobjects.com/os/lib/pixi.js/5.1.5/dist/pixi.js" crossorigin="anonymous"></script>
    <script src="https://gw.alipayobjects.com/os/lib/babel/standalone/7.6.4/babel.min.js"
        crossorigin="anonymous"></script>

    <style>
        :root {
            --control-color: #5188f1;
        }

        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            font-family: 'Avenir', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-align: center;
            color: #2c3e50;
        }

        .absolute {
            position: absolute;
        }

        .internal {
            border: 1px solid var(--control-color);
        }

        .handler {
            display: block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            border: 1px solid var(--control-color);
            margin-left: -4px;
            margin-top: -4px;
            background: white;

        }

        .rotate {
            left: 50%;
            top: -15px;
        }

        .rotate::after {
            content: '';
            display: block;
            position: absolute;
            top: 7px;
            border-left: 1px solid var(--control-color);
            height: 10px;
            left: 3px;
        }

        .l {
            left: 0;
        }

        .c {
            left: 50%;
        }

        .r {
            left: 100%;
        }

        .t {
            top: 0;
        }

        .m {
            top: 50%;
        }

        .b {
            top: 100%;
        }

        .rotate-guide {
            pointer-events: none;
            border-radius: 50%;
            border: 1px dashed var(--control-color);
        }

        .resize-guide {
            pointer-events: none;
            width: 0;
            border-left: 1px dashed var(--control-color);
            height: 2000px;
        }
    </style>
</head>

<body>
    <div id="root"></div>
</body>
<script>
    var bootstrap = { biz: null, lib: null };
    Promise.all([
        new Promise((resolve) => bootstrap.lib = resolve),
        new Promise((resolve) => bootstrap.biz = resolve),
    ]).then(([lib, biz]) => {
        biz(lib);
    })
</script>
<script type="text/babel">
    bootstrap.biz((lib) => {
        const {
            angleDegrees,
            lineDegrees,
            computeEndPoints,
            pointsDistance,
            centerPoint,
            default: rotateResize
        } = lib;

        const handlers = [
            'rotate',
            'lt',
            'ct',
            'rt',
            'lm',
            'rm',
            'lb',
            'cb',
            'rb'
        ];

        class Rect extends React.Component {
            constructor() {
                super();
                this.state = {
                    adjustType: null,
                    isAdjusting: false,
                    fixedRatio: false,
                };
            }

            bounds() {
                return computeEndPoints(this.props.rect)
            }

            showRotateGuide() {
                return this.state.adjustType === 'rotate'
            }

            rotateGuideStyle() {
                if (!this.showRotateGuide()) {
                    return {}
                }
                const { center, lt, rb } = this.bounds()
                const { x, y } = center
                const w = pointsDistance(lt, rb)
                return {
                    left: `${x - w / 2}px`,
                    top: `${y - w / 2}px`,
                    width: `${w}px`,
                    height: `${w}px`
                }
            }

            showResizeGuide() {
                return this.state.fixedRatio &&
                this.state.adjustType &&
                this.state.adjustType !== 'rotate'
            }

            resizeGuideStyle() {
                if (!this.showResizeGuide()) {
                    return {}
                }
                let p0, p1
                const t = this.state.adjustType
                const e = this.bounds()
                if (t === 'lt' || t === 'rb') {
                    [p0, p1] = [e.lt, e.rb]
                } else if (t === 'rt' || t === 'lb') {
                    [p0, p1] = [e.rt, e.lb]
                } else if (t === 'cb' || t === 'ct') {
                    [p0, p1] = [e.cb, e.ct]
                } else {
                    [p0, p1] = [e.lm, e.rm]
                }
                const height = 10000
                const center = centerPoint(p0, p1)
                const r = lineDegrees(p0, p1)
                return {
                    left: `${center.x}px`,
                    top: `${center.y - height / 2}px`,
                    height: `${height}px`,
                    transform: `rotate(${r}deg)`
                }
            }

            internalStyle() {
                const { x, y, w, h, r } = this.props.rect
                const rad = (Math.PI / 180) * r
                const a = Math.cos(rad)
                const c = -Math.sin(rad)
                const b = -c
                const d = a
                return {
                    width: `${w}px`,
                    height: `${h}px`,
                    transform: ` matrix(${a}, ${b}, ${c}, ${d}, ${x}, ${y})`,
                }
            }

            showHandlers() {
                if (this.state.isAdjusting && this.state.adjustType === 'move') {
                    return false
                }
                return true
            }

            computeMousePosition(e) {
                const { pageX, pageY } = e
                return {
                    x: pageX,
                    y: pageY
                }
            }

            onMouseDown = (e, type) => {
                e.stopPropagation();
                this.mouseStart = this.computeMousePosition(e)
                this.rectStart = { ...this.props.rect }
                this.setState({ fixedRatio: e.shiftKey, adjustType: e.metaKey ? 'rotate' : type });

                document.addEventListener('mousemove', this.onMouseMove)
                document.addEventListener('mouseup', this.onMouseUp)
            }

            onMouseMove = (e) => {
                this.mouseEnd = this.computeMousePosition(e)
                const [x, y] = ['x', 'y'].map(t => Math.abs(this.mouseEnd[t] - this.mouseStart[t]))
                if (x > 2 || y > 2) {
                    this.setState({ isAdjusting: true });
                    this.setDocumentCursor(this.mouseEnd)
                    const rectEnd = rotateResize(
                        this.state.adjustType,
                        this.mouseStart,
                        this.mouseEnd,
                        this.rectStart,
                        this.state.fixedRatio
                    )
                    this.props.onTransformed(rectEnd);
                }
            }

            onMouseUp = () => {
                this.setState({ adjustType: null });
                this.setBodyCursor('auto');
                document.removeEventListener('mousemove', this.onMouseMove)
                document.removeEventListener('mouseup', this.onMouseUp)
            }

            setBodyCursor(cursor) {
                document.body.style.cursor = cursor
            }

            setDocumentCursor(point, tolerate = true) {
                if (this.state.adjustType === 'move') {
                    return this.setBodyCursor('move')
                }
                if (this.state.adjustType === 'rotate') {
                    return this.setBodyCursor('-webkit-grab')
                }
                const { center } = this.bounds()
                const vector = {
                    x: (point.x || 0) - center.x,
                    y: (point.y || 0) - center.y
                }
                const degrees = angleDegrees(vector)
                const toleratance = tolerate ? 10 : 0

                switch (true) {
                    case degrees <= -180 + toleratance:
                        return this.setBodyCursor('ew-resize');
                    case degrees < -90 - toleratance:
                        return this.setBodyCursor('nwse-resize');
                    case degrees <= -90 + toleratance:
                        return this.setBodyCursor('ns-resize');
                    case degrees < 0 - toleratance:
                        return this.setBodyCursor('nesw-resize');
                    case degrees <= 0 + toleratance:
                        return this.setBodyCursor('ew-resize');
                    case degrees < 90 - toleratance:
                        return this.setBodyCursor('nwse-resize');
                    case degrees <= 90 + toleratance:
                        return this.setBodyCursor('ns-resize');
                    case degrees < 180 - toleratance:
                        return this.setBodyCursor('nesw-resize');
                    case degrees <= 180 + toleratance:
                        return this.setBodyCursor('ew-resize');
                }

            }

            preventDrag = (e) => {
                e.stopPropagation()
                e.preventDefault()
            };

            componentDidMount() {
                document.addEventListener('drag', this.preventDrag)
                document.addEventListener('dragstart', this.preventDrag)
            }

            componentWillUnmount() {
                document.removeEventListener('drag', this.preventDrag)
                document.removeEventListener('dragstart', this.preventDrag)
            }

            render() {
                return (
                    <div className="controller">
                        <div className="absolute internal" style={this.internalStyle()} onMouseDown={($event) => this.onMouseDown($event, 'move')}>
                            {this.showHandlers() && handlers.map((handler) => (<i
                                key={handler}
                                className={'handler absolute ' + (handler === 'rotate' ? handler : handler.split('').join(' '))}
                                onMouseDown={($event) => this.onMouseDown($event, handler)}
                            ></i>)) || null}
                        </div>
                        {this.showResizeGuide() &&
                            <div
                                className="absolute resize-guide"
                                style={this.resizeGuideStyle()}
                            ></div>}
                        {this.showRotateGuide() && <div
                            className="absolute rotate-guide"
                            style={this.rotateGuideStyle()}
                        ></div>}
                    </div >
                );
            }
        }

        const App = () => {
            const [rect, setRect] = React.useState({
                x: 100,
                y: 100,
                w: 100,
                h: 100,
                r: 0
            });

            return <Rect rect={rect} onTransformed={setRect} />;
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    });
</script>

<script type="module">
    import * as lib from './rotateResize.js';
    bootstrap.lib(lib);
</script>