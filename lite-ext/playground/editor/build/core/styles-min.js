KISSY.Editor.add("styles",function(p){function K(a,e){for(var b in a)a[b]=a[b].replace(T,function(c,d){return e[d]})}function B(a,e){if(e){a=u.clone(a);K(a.attributes,e);K(a.styles,e)}var b=this.element=(a.element||"*").toLowerCase();this.type=b=="#"||U[b]?n.STYLE_BLOCK:L[b]?n.STYLE_OBJECT:n.STYLE_INLINE;this._={definition:a}}function M(a,e){var b=e?this.removeFromRange:this.applyToRange;a.body.focus();for(var c=new V(a),d=c.getRanges(),g=0;g<d.length;g++)b.call(this,d[g]);c.selectRanges(d)}function E(a,
e){var b;b=a.element;if(b=="*")b="span";b=new w(e.createElement(b));return N(b,a)}function N(a,e){var b=e._.definition,c=b.attributes;b=B.getStyleText(b);if(c)for(var d in c)a.attr(d,c[d]);if(b)a[0].style.cssText=b;return a}function W(a){var e=a.createBookmark(true),b=a.createIterator();b.enforceRealBlocks=true;b.enlargeBr=true;for(var c,d=a.document;c=b.getNextParagraph();){var g=E(this,d);c=c;var f=g;g=f._4e_name=="pre";var h=c._4e_name=="pre",l=!g&&h;if(g&&!h){h=c;f=f;l=h.html();l=x(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,
"");l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");l=l.replace(/([ \t\n\r]+|&nbsp;)/g," ");l=l.replace(/<br\b[^>]*>/gi,"\n");if(F.ie){h=h[0].ownerDocument.createElement("div");h.appendChild(f[0]);f[0].outerHTML="<pre>"+l+"</pre>";f=new w(h.firstChild);f._4e_remove()}else f.html(l);f=f}else if(l)f=X(Y(c),f);else c._4e_moveChildren(f);c[0].parentNode.replaceChild(f[0],c[0]);if(g){c=f;g=void 0;if((g=c._4e_previousSourceNode(true,v.NODE_ELEMENT))&&g._4e_name()=="pre"){f=x(g.html(),/\n$/,"")+"\n\n"+
x(c.html(),/^\n/,"");if(F.ie)c[0].outerHTML="<pre>"+f+"</pre>";else c.html(f);g._4e_remove()}}}a.moveToBookmark(e)}function x(a,e,b){var c="",d="";a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(g,f,h){f&&(c=f);h&&(d=h);return""});return c+a.replace(e,b)+d}function Y(a){var e=[];x(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(b,
c){e.push(c)});return e}function X(a,e){for(var b=e[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var d=a[c];d=d.replace(/(\r\n|\r)/g,"\n");d=x(d,/^[ \t]*\n/,"");d=x(d,/\n$/,"");d=x(d,/^[ \t]+|[ \t]+$/g,function(f,h){return f.length==1?"&nbsp;":h?" "+Array(f.length).join("&nbsp;"):Array(f.length).join("&nbsp;")+" "});d=d.replace(/\n/g,"<br>");d=d.replace(/[ \t]{2,}/g,function(f){return Array(f.length).join("&nbsp;")+" "});var g=e._4e_clone();g.html(d);b.appendChild(g[0])}return b}
function Z(a){var e=a.document;if(a.collapsed){e=E(this,e);a.insertNode(e);a.moveToPosition(e,z.POSITION_BEFORE_END)}else{var b=this.element,c=this._.definition,d,g=p.XHTML_DTD[b]||(d=true,p.XHTML_DTD.span),f=a.createBookmark();a.enlarge(z.ENLARGE_ELEMENT);a.trim();var h=a.createBookmark(),l=h.startNode;h=h.endNode;for(var k=l,q;k&&k[0];){var i=false;if(y._4e_equals(k,h)){k=null;i=true}else{var j=k[0].nodeType,t=j==v.NODE_ELEMENT?k._4e_name():null;if(t&&k.attr("_ke_bookmark")){k=k._4e_nextSourceNode(true);
continue}if(!t||g[t]&&(k._4e_position(h)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(k))){var o=k.parent();if(o&&o[0]&&((p.XHTML_DTD[o._4e_name()]||p.XHTML_DTD.span)[b]||d)&&(!c.parentRule||c.parentRule(o))){if(!q&&(!t||!p.XHTML_DTD.$removeEmpty[t]||(k._4e_position(h)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED)){q=
new $(e);q.setStartBefore(k)}if(j==v.NODE_TEXT||j==v.NODE_ELEMENT&&!k[0].childNodes.length){j=k;for(var r;!j[0].nextSibling&&(r=j.parent(),g[r._4e_name()])&&(r._4e_position(l)|m.POSITION_FOLLOWING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_FOLLOWING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(r));)j=r;q.setEndAfter(j);j[0].nextSibling||(i=true)}}else i=true}else i=true;k=k._4e_nextSourceNode()}if(i&&q&&!q.collapsed){i=E(this,e);for(j=q.getCommonAncestor();i&&
j&&i[0]&&j[0];){if(j._4e_name()==b){for(var s in c.attributes)i.attr(s)==j.attr(s)&&i[0].removeAttribute(s);for(var G in c.styles)i._4e_style(G)==j._4e_style(G)&&i._4e_style(G,"");if(!i._4e_hasAttributes()){i=null;break}}j=j.parent()}if(i){i[0].appendChild(q.extractContents());j=i;t=C(this);o=j.all(this.element);for(var A=o.length;--A>=0;)H(this,new w(o[A]));var D=void 0;for(D in t)if(D!=this.element){o=j.all(D);for(A=o.length-1;A>=0;A--){var aa=new w(o[A]);I(aa,t[D])}}q.insertNode(i);i._4e_mergeSiblings();
F.ie||i[0].normalize()}q=null}}l._4e_remove();h._4e_remove();a.moveToBookmark(f);a.shrink(z.SHRINK_TEXT)}}function ba(a){a.enlarge(z.ENLARGE_ELEMENT);var e=a.createBookmark(),b=e.startNode;if(a.collapsed){for(var c=new J(b.parent()),d,g=0,f;g<c.elements.length&&(f=c.elements[g]);g++){if(f==c.block||f==c.blockLimit)break;if(this.checkElementRemovable(f)){var h=a.checkBoundaryOfElement(f,z.END),l=!h&&a.checkBoundaryOfElement(f,z.START);if(l||h){d=f;d.match=l?"start":"end"}else{f._4e_mergeSiblings();
f._4e_name()==this.element?H(this,f):I(f,C(this)[f._4e_name()])}}}if(d&&d[0]){f=b;for(g=0;;g++){h=c.elements[g];if(y._4e_equals(h,d))break;else if(h.match)continue;else h=h._4e_clone();h[0].appendChild(f[0]);f=h}y[d.match=="start"?"insertBefore":"insertAfter"](f[0],d[0])}}else{var k=e.endNode,q=this;c=function(){for(var i=new J(b.parent()),j=new J(k.parent()),t=null,o=null,r=0;r<i.elements.length;r++){var s=i.elements[r];if(s==i.block||s==i.blockLimit)break;if(q.checkElementRemovable(s))t=s}for(r=
0;r<j.elements.length;r++){s=j.elements[r];if(s==j.block||s==j.blockLimit)break;if(q.checkElementRemovable(s))o=s}o&&k._4e_breakParent(o);t&&b._4e_breakParent(t)};c();for(d=new w(b[0].nextSibling);d[0]!==k[0];){g=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==v.NODE_ELEMENT&&this.checkElementRemovable(d)){d._4e_name()==this.element?H(this,d):I(d,C(this)[d._4e_name()]);if(g[0].nodeType==v.NODE_ELEMENT&&g._4e_contains(b)){c();g=new w(b[0].nextSibling)}}d=g}}a.moveToBookmark(e)}function O(a){var e={};
a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,d){e[c]=d});return e}function P(a,e){var b;if(e!==false){b=document.createElement("span");b.style.cssText=a;b=b.style.cssText||""}else b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function C(a){if(a._.overrides)return a._.overrides;var e=a._.overrides={},b=a._.definition.overrides;if(b){u.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++){var d=b[c],g,f;if(typeof d==
"string")g=d.toLowerCase();else{g=d.element?d.element.toLowerCase():a.element;f=d.attributes}d=e[g]||(e[g]={});if(f){d=d.attributes=d.attributes||[];for(var h in f)d.push([h.toLowerCase(),f[h]])}}}return e}function H(a,e){var b=a._.definition,c=u.mix(u.mix({},b.attributes),C(a)[e._4e_name()]);b=b.styles;var d=u.isEmptyObject(c)&&u.isEmptyObject(b),g;for(g in c)if(!((g=="class"||a._.definition.fullMatch)&&e.attr(g)!=Q(g,c[g]))){d=d||!!e._4e_hasAttribute(g);e.removeAttr(g)}for(var f in b)if(!(a._.definition.fullMatch&&
e._4e_style(f)!=Q(f,b[f],true))){d=d||!!e._4e_style(f);e._4e_style(f,"")}d&&R(e)}function Q(a,e,b){var c=new w("<span></span>");c[b?"_4e_style":"attr"](a,e);return c[b?"_4e_style":"attr"](a)}function I(a,e){var b=e&&e.attributes;if(b)for(var c=0;c<b.length;c++){var d=b[c][0],g;if(g=a.attr(d)){var f=b[c][1];if(f===null||f.test&&f.test(g)||typeof f=="string"&&g==f)a[0].removeAttribute(d)}}R(a)}function R(a){if(!a._4e_hasAttributes()){var e=a[0].firstChild,b=a[0].lastChild;a._4e_remove(true);if(e){e.nodeType==
v.NODE_ELEMENT&&y._4e_mergeSiblings(e);b&&!e===b&&b.nodeType==v.NODE_ELEMENT&&y._4e_mergeSiblings(b)}}}var u=KISSY,y=u.DOM,n=p.STYLE={},z=p.RANGE,V=p.Selection,v=p.NODE,m=p.POSITION,$=p.Range,w=u.Node,F=u.UA,J=p.ElementPath,U={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},S=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;n.STYLE_BLOCK=1;n.STYLE_INLINE=2;n.STYLE_OBJECT=3;B.prototype={apply:function(a){M.call(this,
a,false)},remove:function(a){M.call(this,a,true)},applyToRange:function(a){return(this.applyToRange=this.type==n.STYLE_INLINE?Z:this.type==n.STYLE_BLOCK?W:this.type==n.STYLE_OBJECT?null:null).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==n.STYLE_INLINE?ba:null).call(this,a)},applyToObject:function(a){N(a,this)},checkElementRemovable:function(a,e){if(!a)return false;var b=this._.definition;if(a._4e_name()==this.element){if(!e&&!a._4e_hasAttributes())return true;var c=
b._AC;if(c)b=c;else{c={};var d=0,g=b.attributes;if(g)for(var f in g){d++;c[f]=g[f]}if(g=B.getStyleText(b)){c.style||d++;c.style=g}c._length=d;b=b._AC=c}if(b._length){for(var h in b)if(h!="_length"){d=a.attr(h)||"";if(h=="style")a:{c=b[h];d=P(d,false);typeof c=="string"&&(c=O(c));typeof d=="string"&&(d=O(d));g=void 0;for(g in c)if(!(g in d&&(d[g]==c[g]||c[g]=="inherit"||d[g]=="inherit"))){c=false;break a}c=true}else c=b[h]==d;if(c){if(!e)return true}else if(e)return false}if(e)return true}else return true}if(h=
C(this)[a._4e_name()]){if(!(b=h.attributes))return true;for(c=0;c<b.length;c++){h=b[c][0];if(h=a.attr(h)){d=b[c][1];if(d===null||typeof d=="string"&&h==d||d.test&&d.test(h))return true}}}return false},checkActive:function(a){switch(this.type){case n.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,true);case n.STYLE_OBJECT:case n.STYLE_INLINE:for(var e=a.elements,b=0,c;b<e.length;b++){c=e[b];if(!(this.type==n.STYLE_INLINE&&(y._4e_equals(c,a.block)||y._4e_equals(c,a.blockLimit))))if(!(this.type==
n.STYLE_OBJECT&&!(c._4e_name()in L)))if(this.checkElementRemovable(c,true))return true}}return false}};B.getStyleText=function(a){var e=a._ST;if(e)return e;e=a.styles;var b=a.attributes&&a.attributes.style||"",c="";if(b.length)b=b.replace(S,";");for(var d in e){var g=e[d],f=(d+":"+g).replace(S,";");if(g=="inherit")c+=f;else b+=f}if(b.length)b=P(b);b+=c;return a._ST=b};p.Style=B});
