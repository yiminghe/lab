KISSY.Editor.add("htmldataprocessor",function(r){function x(a){if(/mso-list\s*:\s*Ignore/i.test(a.attributes&&a.attributes.style))return true;return n}function y(a,c){var b=new j.HtmlParser.Element("ke:listbullet"),d;if(a)if(a[2]){a=isNaN(a[1])?/^[a-z]+$/.test(a[1])?"lower-alpha":/^[A-Z]+$/.test(a[1])?"upper-alpha":"decimal":"decimal";d="ol"}else{a=/[l\u00B7\u2002]/.test(a[1])?"disc":/[\u006F\u00D8]/.test(a[1])?"circle":/[\u006E\u25C6]/.test(a[1])?"square":"disc";d="ul"}else{a="decimal";d="ol"}b.attributes=
{"ke:listtype":d,style:"list-style-type:"+a+";"};b.add(new j.HtmlParser.Text(c));return b}function E(a){var c=a.attributes,b;if((b=a.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){a.name="ke:li";if(c.style)c.style=t([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(d){d=d.split(" ");d=d[3]||d[1]||d[0];d=parseInt(d,10);if(!q&&s&&d>s)q=d-s;c["ke:margin"]=s=d}]],n)(c.style,a)||"";b=b.attributes;a.addStyle(b.style);u.mix(c,b);return true}return false}function t(a,c){return function(b,
d){var e=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(f,h,k){h=h.toLowerCase();h=="font-family"&&(k=k.replace(/["']/g,""));for(var o,i,z,l=0;l<a.length;l++)if(a[l]){f=a[l][0];o=a[l][1];i=a[l][2];z=a[l][3];if(h.match(f)&&(!o||k.match(o))){h=z||h;c&&(i=i||k);if(typeof i=="function")i=i(k,d,h);if(i&&i.push){h=i[0];i=i[1]}typeof i=="string"&&e.push([h,i]);return}}!c&&e.push([h,k])});for(var g=0;g<e.length;g++)e[g]=e[g].join(":");return e.length?e.join(";")+";":
false}}function A(a){a=a.children;for(var c,b,d,e,g,f,h,k=0;k<a.length;k++){c=a[k];if("ke:li"==c.name){c.name="li";c=c;b=c.attributes;d=c.attributes["ke:listtype"];e=parseInt(b["ke:indent"],10)||q&&Math.ceil(b["ke:margin"]/q)||1;b.style&&(b.style=t([["list-style-type",d=="ol"?"decimal":"disc"]],n)(b.style)||"");if(f){if(e>h){f=new j.HtmlParser.Element(d);f.add(c);g.add(f)}else{if(e<h){g=h-e;for(var o;g--&&(o=f.parent);)f=o.parent}f.add(c)}a.splice(k--,1)}else{f=new j.HtmlParser.Element(d);f.add(c);
a[k]=f}g=c;h=e}else f=null}q=0}var n=n,j=KISSY.Editor,u=KISSY,m=u.UA,F=j.NODE,p=j.HtmlParser,v=new p.Filter,w=new p.Filter,B=j.XHTML_DTD;if(!r.htmlDataProcessor){(function(){var a=j.HtmlParser.Fragment.prototype,c=j.HtmlParser.Element.prototype;a.onlyChild=c.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};c.removeAnyChildWithName=function(b){for(var d=this.children,e=[],g,f=0;f<d.length;f++){g=d[f];if(g.name){if(g.name==b){e.push(g);d.splice(f--,1)}e=e.concat(g.removeAnyChildWithName(b))}}return e};
c.getAncestor=function(b){for(var d=this.parent;d&&!(d.name&&d.name.match(b));)d=d.parent;return d};a.firstChild=c.firstChild=function(b){for(var d,e=0;e<this.children.length;e++){d=this.children[e];if(b(d))return d;else if(d.name)if(d=d.firstChild(b))return d}return null};c.addStyle=function(b,d,e){var g="";if(typeof d=="string")g+=b+":"+d+";";else{if(typeof b=="object")for(var f in b){if(b.hasOwnProperty(f))g+=f+":"+b[f]+";"}else g+=b;e=d}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(e?[g,b]:[b,g]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};B.parentOf=function(b){var d={},e;for(e in this)if(e.indexOf("$")==-1&&this[e][b])d[e]=1;return d}})();var C=t([[/mso/i],[/font-size/i,"",function(a){for(var c=r.cfg.pluginConfig["font-size"],b=0;b<c.items.length;b++)if(a.toLowerCase()==c.items[b].size)return a;return false},"font-size"],[/font-family/i,"",function(a){for(var c=r.cfg.pluginConfig["font-family"],b=0;b<c.length;b++)if(a.toLowerCase()==c[b].toLowerCase())return a;
return false},"font-family"],[/line-height/i],[/display/i,/none/i]],n),q,s=0,G=B.parentOf("ol"),H={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren();A(a)},elements:{font:function(a){delete a.name},p:function(a){a.filterChildren();if(E(a))return n},$:function(a){var c=a.name||"";c.indexOf(":")!=-1&&c.indexOf("ke")==-1&&delete a.name;var b=a.attributes.style;if(c=="span"&&(!b||
!C(b)))delete a.name;if(c in G){a.filterChildren();A(a)}},table:function(a){var c=a.attributes.border;if(!c||c=="0")a.attributes["class"]="ke_show_border"},td:function(a){if(m.ie){a=a.children;var c=new j.HtmlParser.Text("&nbsp;");if(a.length)a[a.length-1].type!=F.NODE_TEXT&&a.push(c);else a.push(c)}},span:function(a){if(!m.gecko&&x(a.parent))return false;if(!m.gecko&&x(a)){a=(a=a.firstChild(function(b){return b.value||b.name=="img"}))&&(a.value||"l.");var c=a.match(/^([^\s]+?)([.)]?)$/);return y(c,
a)}}},comment:!m.ie?function(a,c){var b=a.match(/<img.*?>/),d=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(d){d=(b=d[1]||b&&"l.")&&b.match(/>([^\s]+?)([.)]?)</);return y(d,b)}if(m.gecko&&b){b=j.HtmlParser.Fragment.FromHtml(b[0]).children[0];(d=(d=(d=c.previous)&&d.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&d[1])&&(b.attributes.src=d);return b}return false}:function(){return false},attributes:{"class":function(a){if(/^ke_/.test(a))return a;return false},style:function(a){a=C(a);
if(!a)return false;return a}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},D={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(a){var c=a.parent;if(c&&c.name=="object"){var b=c.attributes.width;c=c.attributes.height;b&&(a.attributes.width=b);c&&(a.attributes.height=c)}},param:function(a){a.children=[];a.isEmpty=true;return a},a:function(a){if(!(a.children.length||a.attributes.name))return false},td:function(a){for(var c=a.children,b=0;b<c.length;b++)if(c[b].name=="br"){c.splice(b,
1);--b}if(!a.children.length){c=new j.HtmlParser.Text("&nbsp;");a.children.push(c)}},span:function(a){if(!a.children.length)return false}},attributes:{style:function(a){if(!u.trim(a))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(m.ie)D.attributes.style=function(a){return a.toLowerCase()};v.addRules(D);w.addRules(H);r.htmlDataProcessor={htmlFilter:v,dataFilter:w,toHtml:function(a,c){var b=new p.HtmlWriter;p.Fragment.FromHtml(a,c).writeHtml(b,v);return b.getHtml(true)},toDataFormat:function(a,
c){if(m.gecko)a=a.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new p.BasicWriter,d=p.Fragment.FromHtml(a,c);b.reset();d.writeHtml(b,w);return b.getHtml(true)}}}});
