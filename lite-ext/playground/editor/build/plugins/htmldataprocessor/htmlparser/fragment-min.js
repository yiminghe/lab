KISSY.Editor.add("htmlparser-fragment",function(){function s(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var j=KISSY.Editor;if(!j.HtmlParser.Fragment){var B={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},C=KISSY,t=j.Utils,w=j.NODE,g=j.XHTML_DTD,D=t.mix({table:1,ul:1,ol:1,dl:1},g.table,g.ul,g.ol,g.dl),z=g.$list,E=g.$listItem;s.FromHtml=function(i,e){function n(b){var f;if(k.length>0)for(var h=0;h<k.length;h++){var d=k[h],c=d.name,l=
g[c],p=a.name&&g[a.name];if((!p||p[c])&&(!b||!l||l[b]||!g[b])){if(!f){m();f=1}d=d.clone();d.parent=a;a=d;k.splice(h,1);h--}}}function m(){for(;x.length;)a.add(x.shift())}function q(b,f,h){f=f||a||y;if(e&&!f.type){var d,c;if((d=b.attributes&&(c=b.attributes._ke_real_element_type)?c:b.name)&&!(d in g.$body)&&!(d in g.$nonBodyContent)){d=a;a=f;o.onTagOpen(e,{});f=a;if(h)a=d}}if(b._.isBlockLike&&b.name!="pre"){h=b.children.length;if((d=b.children[h-1])&&d.type==w.NODE_TEXT)if(c=t.rtrim(d.value))d.value=
c;else b.children.length=h-1}f.add(b);if(b.returnPoint){a=b.returnPoint;delete b.returnPoint}}var o=new j.HtmlParser,y=new s,k=[],x=[],a=y,u=false,v;o.onTagOpen=function(b,f,h){var d=new j.HtmlParser.Element(b,f);if(d.isUnknown&&h)d.isEmpty=true;if(g.$removeEmpty[b])k.push(d);else{if(b=="pre")u=true;else if(b=="br"&&u){a.add(new j.HtmlParser.Text("\n"));return}if(b=="br")x.push(d);else{var c=a.name,l=c&&(g[c]||(a._.isBlockLike?g.div:g.span));if(l&&!d.isUnknown&&!a.isUnknown&&!l[b]){l=false;var p;
if(b in z&&c in z){c=a.children;(c=c[c.length-1])&&c.name in E||q(c=new j.HtmlParser.Element("li"),a);v=a;p=c}else if(b==c)q(a,a.parent);else{if(D[c])v||(v=a);else{q(a,a.parent,true);B[c]||k.unshift(a)}l=true}a=p?p:a.returnPoint||a.parent;if(l){o.onTagOpen.apply(this,arguments);return}}n(b);m();d.parent=a;d.returnPoint=v;v=0;if(d.isEmpty)q(d);else a=d}}};o.onTagClose=function(b){for(var f=k.length-1;f>=0;f--)if(b==k[f].name){k.splice(f,1);return}for(var h=[],d=[],c=a;c.type&&c.name!=b;){c._.isBlockLike||
d.unshift(c);h.push(c);c=c.parent}if(c.type){for(f=0;f<h.length;f++){var l=h[f];q(l,l.parent)}a=c;if(a.name=="pre")u=false;c._.isBlockLike&&m();q(c,c.parent);if(c==a)a=a.parent;k=k.concat(d)}if(b=="body")e=false};o.onText=function(b){if(!a._.hasInlineStarted&&!u){b=t.ltrim(b);if(b.length===0)return}m();n();if(e&&(!a.type||a.name=="body")&&t.trim(b))this.onTagOpen(e,{});u||(b=b.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));a.add(new j.HtmlParser.Text(b))};o.onCDATA=function(){};o.onComment=function(b){a.add(new j.HtmlParser.Comment(b))};
o.parse(i);for(m();a.type;){var r=a.parent,A=a;if(e&&(!r.type||r.name=="body")&&!g.$body[A.name]){a=r;o.onTagOpen(e,{});r=a}r.add(A);a=r}return y};C.augment(s,{add:function(i){var e=this.children.length;if(e=e>0&&this.children[e-1]||null){if(i._.isBlockLike&&e.type==w.NODE_TEXT){e.value=t.rtrim(e.value);if(e.value.length===0){this.children.pop();this.add(i);return}}e.next=i}i.previous=e;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==w.NODE_TEXT||i.type==w.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,e){var n;this.filterChildren=function(){var m=new j.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,m,e,true);m=m.getHtml();this.children=(new s.FromHtml(m)).children;n=1};!this.name&&e&&e.onFragment(this);this.writeChildrenHtml(i,n?null:e)},writeChildrenHtml:function(i,e){for(var n=0;n<this.children.length;n++)this.children[n].writeHtml(i,e)}});j.HtmlParser.Fragment=s}});
