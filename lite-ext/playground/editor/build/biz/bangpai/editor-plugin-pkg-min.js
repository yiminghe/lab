KISSY.Editor.add("bangpai-music",function(u){var k=KISSY,s=k.UA,v=k.Event,o=k.Editor,w=k.DOM,p=k.Node,z=o.Config.base+"theme/loading.gif",t=o.Flash,a="ke_xiami",d=u.htmlDataProcessor,h=d&&d.dataFilter;h&&h.addRules({elements:{object:function(g){var c=g.attributes,e=g.attributes.title,l;if(!(c.classid&&String(c.classid).toLowerCase())){for(c=0;c<g.children.length;c++){l=g.children[c];if(l.name=="embed"){if(!t.isFlashEmbed(l))break;if(/xiami\.com/i.test(l.attributes.src))return d.createFakeParserElement(g,
a,"bangpai-music",true,{title:e})}}return null}for(c=0;c<g.children.length;c++){l=g.children[c];if(l.name=="param"&&l.attributes.name=="movie")if(/xiami\.com/i.test(l.attributes.value))return d.createFakeParserElement(g,a,"bangpai-music",true,{title:e})}},embed:function(g){if(!t.isFlashEmbed(g))return null;if(/xiami\.com/i.test(g.attributes.src))return d.createFakeParserElement(g,a,"bangpai-music",true,{title:g.attributes.title})}}},4);o.BangPaiMusic||function(){function g(f){g.superclass.constructor.apply(this,
arguments);f.cfg.disableObjectResizing||v.on(f.document.body,s.ie?"resizestart":"resize",function(b){w.hasClass(b.target,a)&&b.preventDefault()})}function c(f){return r.replace(/\${([^}]+)}/g,function(b,j){return f[j]})}function e(f,b,j){return"<a class='ke-xiami-page-item"+(f==b?" ke-xiami-curpage":"")+"' data-value='"+b+"' href='#'>"+(j||b)+"</a>"}function l(f){return f._4e_name()==="img"&&!!f.hasClass(a)&&f}w.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;width:300px;white-space:nowrap;overflow:hidden;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(f){var b=bangpai_xiami.instance;f.page=bangpai_xiami.page;b._listSearch(f)};var r="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";k.extend(g,t,{_config:function(){this._cls=a;this._type="bangpai-music";this._title="\u867e\u7c73\u5c5e\u6027";this._bodyHtml="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url ke-input' style='width:300px;vertical-align:middle;'/> &nbsp;  <button class='ke-xiami-submit'>\u641c \u7d22 </button></p><p style='margin:10px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><label style='margin-left:45px;'>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-xiami-margin ke-input' style='width:60px' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div>";
this._footHtml="<button class='ke-xiami-ok ke-button'>\u786e&nbsp;\u5b9a</button><button class='ke-xiami-cancel ke-button' style='margin-left:20px;'>\u53d6&nbsp;\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=x;this._flashRules=["img."+a];this._config_dwidth="430px"},_updateTip:function(f,b){var j=this.editor.restoreRealElement(b);if(j){f.html(b.attr("title"));f.attr("href",this._getFlashUrl(j))}},_initD:function(){function f(q){var n=m.val();if(n.replace(/[^\x00-\xff]/g,"@@").length>
30)alert("\u957f\u5ea6\u4e0a\u965030\u4e2a\u5b57\u7b26\uff081\u4e2a\u6c49\u5b57=2\u4e2a\u5b57\u7b26\uff09");else if(k.trim(n)){b._xiami_submit.disable();n={key:encodeURIComponent(m.val()),page:q,random:(new Date).valueOf()};n=c(n);bangpai_xiami.instance=b;bangpai_xiami.page=q;b._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+z+"'/>");var y=k.getScript(n,{timeout:10,success:function(){},error:function(){y.src="";b._xiami_submit.enable();b._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u8d85\u65f6\u4e86\uff0c\u8bf7\u91cd\u8bd5\uff01</p>")}})}else alert("\u4e0d\u80fd\u4e3a\u7a7a\uff01")}
var b=this,j=b.editor,i=b.d;i.el.one(".ke-xiami-form");var m=i.el.one(".ke-xiami-url");b.dAlign=o.Select.decorate(i.el.one(".ke-xiami-align"));b._xiami_input=m;o.Utils.placeholder(m,"\u8f93\u5165\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");b._xiamia_list=i.el.one(".ke-xiami-list");b._xiami_submit=new o.TripleButton({el:i.el.one(".ke-xiami-submit"),cls:"ke-button",text:"\u641c&nbsp;\u7d22"});b._xiami_submit.on("offClick",function(){f(1)});m.on("keydown",function(q){q.keyCode===13&&f(1)});b.dMargin=i.el.one(".ke-xiami-margin");b._xiami_url_wrap=i.el.one(".ke-xiami-url-wrap");
b._xiamia_title=i.el.one(".ke-xiami-title");var A=i.foot.one(".ke-xiami-ok");i.foot.one(".ke-xiami-cancel").on("click",function(){i.hide()});A.on("click",function(){var q=b.selectedFlash,n=j.restoreRealElement(q);b._dinfo={url:b._getFlashUrl(n),attrs:{title:q.attr("title"),align:b.dAlign.val(),style:"margin:"+(parseInt(b.dMargin.val())||0)+"px;"}};b._gen()},b);b._xiamia_list.on("click",function(q){q.preventDefault();var n=new p(q.target);q=n._4e_ascendant(function(y){return b._xiamia_list._4e_contains(y)&&
y.hasClass("ke-xiami-add")},true);n=n._4e_ascendant(function(y){return b._xiamia_list._4e_contains(y)&&y.hasClass("ke-xiami-page-item")},true);if(q){b._dinfo={url:"http://www.xiami.com/widget/"+q.attr("data-value")+"/singlePlayer.swf",attrs:{title:q.attr("title"),align:b.dAlign.val(),style:"margin:"+(parseInt(b.dMargin.val())||0)+"px;"}};b._gen()}else n&&f(parseInt(n.attr("data-value")))})},_listSearch:function(f){var b,j=f.results,i="";if(f.key==k.trim(this._xiami_input.val())){this._xiami_submit.enable();
if(j&&j.length){i="<ul>";for(b=0;b<j.length;b++){var m=j[b],A=decodeURIComponent(m.song_name)+" - "+decodeURIComponent(m.artist_name);i=i;var q="<li title='"+A+"'><span class='ke-xiami-song'>",n=A;if(n.length>35)n=n.substring(0,35)+"...";i=i+(q+n+"</span><a href='#' title='"+A+"' class='ke-xiami-add' data-value='"+(m.album_id+"_"+m.song_id)+"'>\u9009\u62e9</a></li>")}i+="</ul>";j=f.page;f=Math.floor(f.total/8);b=j-3;m=j+3;if(f>1){if(b<=2){m=Math.min(2-b+m,f-1);b=2}m=Math.min(m,f-1);if(m==f-1)b=Math.max(2,m-
6);i+="<p class='ke-xiami-paging'>"+e(j,1,"1"+(b!=2?"...":""));for(b=b;b<=m;b++)i+=e(j,b);if(m!=f)i+=e(j,f,(m!=f-1?"...":"")+f);i+="</p>"}}else i="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(i)}},_updateD:function(){var f=this.selectedFlash;if(f){this._xiami_input.val(f.attr("title"));this._xiamia_title.html(f.attr("title"));this.dAlign.val(f.attr("align"));this.dMargin.val(parseInt(f._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();
this._xiamia_title.show()}else{o.Utils.resetInput(this._xiami_input);this.dAlign.val("");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiamia_list.html("")},_getDInfo:function(){k.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var x={"\u867e\u7c73\u5c5e\u6027":function(f){var b=f.getSelection();b=b&&b.getStartElement();b=l(b);f=f._toolbars["bangpai-music"];b&&f.show(null,b)}};t.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",l);o.BangPaiMusic=g}();u.addPlugin(function(){new o.BangPaiMusic(u)})},
{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(u){var k=KISSY,s=k.Editor;if(!s.BangPaiUpload){(function(){function v(a){this.editor=a;this._init()}var o=k.DOM,w=k.JSON,p=k.Node,z=s.Config.base+s.Utils.debugUrl("plugins/uploader/uploader.swf"),t={};name="ke-bangpai-upload";o.addStyleSheet(".ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color:#EBEDF1;}.ke-upload-list td,.ke-upload-list th {padding:0.5em;text-align:center;border-bottom:1px solid #c1c8d1;}","ke-BangPaiUpload");
k.augment(v,k.EventTarget,{_init:function(){var a=this,d=a.editor,h=d.cfg.pluginConfig["bangpai-upload"],g=h.holder;g=k.isString(g)?k.one(g):g;var c=(new p("<div style='position:relative;margin:10px;'>\u6279\u91cf\u4e0a\u4f20\u56fe\u7247\uff1a</div>")).appendTo(g);g=(new p("<div style='display:none'>")).appendTo(g);var e=(new p("<button disabled='disabled'>\u6d4f\u89c8</button>")).appendTo(c),l=e.offset();c.offset();c=(new p("<div style='"+("position:absolute;width:"+(e.width()+8)+"px;height:"+(e.height()+8)+"px;z-index:9999;")+"'>")).appendTo(c);
var r=(new p("<div><table class='ke-upload-list'><thead><tr><th>\u5e8f\u53f7</th><th>\u56fe\u7247</th><th>\u5927\u5c0f</th><th>\u4e0a\u4f20\u8fdb\u5ea6</th><th>\u56fe\u7247\u64cd\u4f5c</th></tr></thead><tbody></tbody></table></div>")).appendTo(g).one("tbody"),x=(new p("<p style='margin:10px;text-align:right;'><button>\u786e\u5b9a\u4e0a\u4f20</button></p>")).appendTo(g).one("button"),f=k.guid(name);a.btn=e;a.up=x;c.offset(l);var b=new s.FlashBridge({movie:z,methods:["removeFile","cancel","removeFile","disable","enable","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:c,attrs:{width:e.width(),
height:e.height()},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});a.uploader=b;a._list=r;a._listWrap=g;a._ds=h.serverUrl;a._dsp=h.serverParams||{};a._fileInput=h.fileInput||"Filedata";r.on("click",function(j){var i=new p(j.target);j.halt();if(i.hasClass("ke-upload-insert")){j=i.parent("tr");url=j.attr("url");d.insertElement(new p("<img src='"+url+"'/>",null,d.document))}else if(i.hasClass("ke-upload-delete")){j=i.parent("tr");f=j.attr("fid");try{b.cancel(f)}catch(m){}b.removeFile(f);
t[f].destroy();delete t[f];j._4e_remove();a.enable();a._seqPics()}});b.on("fileSelect",a._onSelect,a);b.on("uploadStart",a._onUploadStart,a);b.on("uploadProgress",a._onProgress,a);b.on("uploadComplete",a._onComplete,a);b.on("uploadCompleteData",a._onUploadCompleteData,a);b.on("swfReady",a._ready,a);b.on("uploadError",a._uploadError,a)},_uploadError:function(a){var d=a.id,h=this._getFileTr(d);d=t[d];if(h){d&&d.destroy();h.one(".ke-upload-progress").html("<span style='color:red'>"+a.status+"</span>")}},
_getFileTr:function(a){for(var d=this._list.all("tr"),h=0;h<d.length;h++){var g=new p(d[h]);if(g.attr("fid")==a)return g}},_onUploadStart:function(a){this.uploader.removeFile(a.id)},_onComplete:function(){},_onUploadCompleteData:function(a){var d=k.trim(a.data).replace(/\\r||\\n/g,"");a=a.id;if(d){d=w.parse(d);if(d.error)this._uploadError({id:a,status:d.error});else if(a=this._getFileTr(a)){a.one(".ke-upload-insert").show();a.attr("url",d.imgUrl)}}},_onProgress:function(a){var d=Math.floor(a.bytesLoaded*
100/a.bytesTotal);(a=t[a.id])&&a.set("progress",d)},disable:function(){this.uploader.disable();this.btn[0].disabled=true},enable:function(){this.uploader.enable();this.btn[0].disabled=false},_seqPics:function(){var a=1;this._list.all(".ke-upload-seq").each(function(d){d.html(a++)})},_getFilesSize:function(a){var d=0,h;for(h in a)d++;return d},_onSelect:function(a){var d=this.uploader,h=this._list,g=0;a=a.fileList;var c=15-h.all("tr").length;if(a){var e=this._getFilesSize(a);e>c&&alert("\u7cfb\u7edf\u5c06\u53ea\u4fdd\u755915\u5f20");
e>=c&&this.disable();this._listWrap.show();for(var l in a)if(a.hasOwnProperty(l)){var r=a[l];if(!this._getFileTr(r.id)){e=Math.floor(r.size/1E3);var x=r.id;g++;if(g>c)d.removeFile(x);else{r=(new p("<tr fid='"+x+"'><td class='ke-upload-seq'></td><td>"+r.name+"</td><td>"+e+"k</td><td class='ke-upload-progress'></td><td><a href='#' class='ke-upload-insert' style='display:none'>[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp; </td></tr>")).appendTo(h);r.one(".ke-upload-progress");
if(e>1E3){this._uploadError({id:x,status:"\u56fe\u7247\u4e0d\u80fd\u8d85\u8fc71M"});d.removeFile(x)}else t[x]=new s.ProgressBar({container:r.one(".ke-upload-progress"),width:"100px",height:"18px"})}}}this._seqPics()}},_ready:function(){var a=this,d=a.uploader,h=a.up;a.btn[0].disabled=false;d.setAllowMultipleFiles(true);d.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);h.on("click",function(g){g.halt();d.uploadAll(a._ds,"POST",a._dsp,a._fileInput)})}});s.BangPaiUpload=v})();u.addPlugin(function(){new s.BangPaiUpload(u)})}},
{attach:false,requires:["flashutils","progressbar","flashbridge"]});
KISSY.Editor.add("bangpai-video",function(u){function k(a){for(var d=0;d<t.length;d++){var h=t[d];if(h.reg.test(a))return h}}var s=KISSY,v=s.Editor,o="ke_video",w=v.Flash,p=u.htmlDataProcessor,z=p&&p.dataFilter;z&&z.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!w.isFlashEmbed(a.children[d]))break;if(k(a.children[d].attributes.src))return p.createFakeParserElement(a,o,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var h=a.children[d];if(h.name=="param"&&h.attributes.name=="movie")if(k(h.attributes.value))return p.createFakeParserElement(a,o,"bangpai-video",true)}},embed:function(a){if(!w.isFlashEmbed(a))return null;if(k(a.attributes.src))return p.createFakeParserElement(a,o,"bangpai-video",true)}}},4);var t=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];v.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(c){return c._4e_name()==="img"&&!!c.hasClass(o)&&c}var h=["img."+o];s.extend(a,w,{_config:function(){var c=
this.editor.cfg.pluginConfig;this._cls=o;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label> \u9ad8\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-video-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-video";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=g;this._flashRules=h;this.urlCfg=c["bangpai-video"]&&c["bangpai-video"].urlCfg},_initD:function(){var c=this,e=c.d;c.dUrl=e.el.one(".ke-video-url");c.dAlign=e.el.one(".ke-video-align");c.dMargin=e.el.one(".ke-video-margin");c.dWidth=e.el.one(".ke-video-width");c.dHeight=e.el.one(".ke-video-height");var l=e.el.one(".ke-video-ok");
e=e.el.one(".ke-video-cancel");l.on("click",c._gen,c);e.on("click",function(){c.d.hide()})},_getDInfo:function(){var c=this.dUrl.val(),e=k(c);if(e)if(c=e.detect(c))return{url:c,attrs:{height:parseInt(this.dHeight.val())||e.height,width:parseInt(this.dWidth.val())||e.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}};else alert("http://");else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_gen:function(){var c=this.dUrl.val(),e=this.urlCfg;if(e)for(var l=0;l<e.length;l++){var r=e[l];if(r.reg.test(c)){this.d.loading();
a.dynamicUrl.origin=c;a.dynamicUrl.instance=this;s.getScript(r.url.replace(/@url@/,encodeURIComponent(c)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(c){this.dUrl.val(c);this.d.unloading();a.superclass._gen.call(this)},_updateD:function(){var c=this.editor,e=this.selectedFlash;if(e){c=c.restoreRealElement(e);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(c.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||
0);this.dWidth.val(c.attr("width"));this.dHeight.val(c.attr("height"))}else{this.dUrl.val("http://");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});a.dynamicUrl=function(c,e){c===a.dynamicUrl.origin&&a.dynamicUrl.instance._dynamicUrlPrepare(e)};w.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",d);v.BangPaiVideo=a;var g={"\u89c6\u9891\u5c5e\u6027":function(c){var e=c.getSelection();e=(e=e&&e.getStartElement())&&d(e);c=c._toolbars["bangpai-video"];e&&c.show(null,e)}}}();u.addPlugin(function(){new v.BangPaiVideo(u)})},
{attach:false,requires:["flashsupport"]});
